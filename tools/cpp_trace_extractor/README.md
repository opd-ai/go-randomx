# RandomX C++ Reference Trace Extractor

This tool extracts traces from the official RandomX C++ reference implementation to help debug the go-randomx implementation.

## Purpose

The go-randomx implementation passes all component tests but produces different hash outputs than the official RandomX test vectors. This tool helps identify where the implementations diverge by:

1. Running the same test inputs through the C++ reference
2. Outputting intermediate values as JSON
3. Allowing comparison with go-randomx debug output

## Prerequisites

Install the RandomX C++ reference implementation:

```bash
# Clone RandomX
git clone https://github.com/tevador/RandomX.git /tmp/RandomX
cd /tmp/RandomX

# Build and install
mkdir build && cd build
cmake -DARCH=native ..
make
sudo make install

# Verify installation
ldconfig -p | grep randomx
```

## Building

```bash
cd tools/cpp_trace_extractor
mkdir build && cd build
cmake ..
make
```

## Usage

### Basic Usage

```bash
./extract_trace "test key 000" "This is a test"
```

Output (JSON):
```json
{
  "test_name": "cpp_reference",
  "key": "test key 000",
  "input": "This is a test",
  "final_hash": "639183aae1bf4c9a35884cb46b09cad9175f04efd7684e7262a0ac1c2f0b4e3f",
  "note": "This trace was generated by the RandomX C++ reference implementation"
}
```

### Generate All Test Vector Traces

```bash
# From repository root
cd /home/runner/work/go-randomx/go-randomx

# Create output directory
mkdir -p testdata/reference_traces

# Generate traces
./tools/cpp_trace_extractor/build/extract_trace \
    "test key 000" \
    "This is a test" \
    > testdata/reference_traces/basic_test_1.json

./tools/cpp_trace_extractor/build/extract_trace \
    "test key 000" \
    "Lorem ipsum dolor sit amet" \
    > testdata/reference_traces/basic_test_2.json

./tools/cpp_trace_extractor/build/extract_trace \
    "test key 000" \
    "sed do eiusmod tempor incididunt ut labore et dolore magna aliqua
" \
    > testdata/reference_traces/basic_test_3.json

./tools/cpp_trace_extractor/build/extract_trace \
    "test key 001" \
    "sed do eiusmod tempor incididunt ut labore et dolore magna aliqua
" \
    > testdata/reference_traces/different_key.json
```

## Current Limitations

The current version outputs only the final hash. To get intermediate values (register states, program outputs, etc.), you would need to:

1. Fork the RandomX repository
2. Add logging statements at key points in the code
3. Rebuild and run this tool against the modified version

Key points to log:
- Initial Blake2b-512 hash of input
- Initial register values (r0-r7)
- Register values after each of the 8 programs
- Final register state before hashing

## Integration with go-randomx

After generating reference traces:

```bash
# Run go-randomx comparison tests
cd /home/runner/work/go-randomx/go-randomx
go test -v -run TestCompareAllVectorsWithReference

# Run with debug output
RANDOMX_DEBUG=1 go test -v -run TestCompareAllVectorsWithReference/basic_test_1
```

## Troubleshooting

**Error: "RandomX library not found"**
- Solution: Install RandomX as described in Prerequisites
- Check: `ldconfig -p | grep randomx`

**Error: "RandomX headers not found"**
- Solution: Ensure RandomX was installed with headers
- Check: `ls /usr/local/include/randomx.h`

**CMake can't find RandomX**
- Solution: Add RandomX install location to CMAKE_PREFIX_PATH
- Example: `cmake -DCMAKE_PREFIX_PATH=/usr/local ..`

## See Also

- [SYSTEMATIC_DEBUGGING_PLAN.md](../../SYSTEMATIC_DEBUGGING_PLAN.md) - Full debugging strategy
- [RandomX Specification](https://github.com/tevador/RandomX) - Official reference
- [go-randomx](../../) - The Go implementation being debugged
